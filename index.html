<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EC Çiftlik Rapor Sistemi</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    body {
      background: linear-gradient(135deg, #fff0f0, #ffffff);
      min-height: 100vh;
      font-family: 'Arial', sans-serif;
    }
    .navbar {
      background-color: #ff3333;
      padding: 1rem;
      border-bottom: 2px solid #cc0000;
    }
    .navbar-brand {
      color: #ffffff;
      font-weight: bold;
      font-size: 1.5rem;
    }
    .card {
      border: none;
      border-radius: 15px;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
      background: #ffffff;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .card:hover {
      transform: translateY(-10px);
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.3);
    }
    .btn-primary {
      background-color: #ff3333;
      border: none;
      transition: background-color 0.3s ease;
    }
    .btn-primary:hover {
      background-color: #cc0000;
    }
    .btn-warning {
      background-color: #ff8533;
      border: none;
      transition: background-color 0.3s ease;
    }
    .btn-warning:hover {
      background-color: #ff6600;
    }
    .btn-danger {
      background-color: #ff4d4d;
      border: none;
      transition: background-color 0.3s ease;
    }
    .btn-danger:hover {
      background-color: #ff1a1a;
    }
    .form-control {
      border-radius: 10px;
      border-color: #ff6666;
      transition: border-color 0.3s ease;
    }
    .form-control:focus {
      border-color: #cc0000;
      box-shadow: 0 0 5px rgba(255, 51, 51, 0.5);
    }
    h1 {
      color: #ff3333;
      font-weight: bold;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
      margin-bottom: 2rem;
    }
    h3 {
      color: #cc0000;
      font-weight: 600;
    }
    #dashboard-content .card {
      margin-bottom: 25px;
    }
    .table {
      background-color: #fff;
      border-radius: 10px;
      overflow: hidden;
    }
    .table th, .table td {
      vertical-align: middle;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    #dashboard, #login-form {
      animation: fadeIn 0.5s ease-in;
    }
    .check-box {
      margin: 5px 0;
      cursor: pointer;
    }
    .checked::after {
      content: '\f00c';
      font-family: "Font Awesome 6 Free";
      font-weight: 900;
      margin-left: 5px;
      color: green;
    }
    .nav-tabs .nav-link {
      color: #cc0000;
    }
    .nav-tabs .nav-link.active {
      background-color: #ff3333;
      color: white;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg">
    <div class="container">
      <a class="navbar-brand" href="#"><i class="fas fa-leaf"></i> EC Çiftlik Rapor</a>
    </div>
  </nav>
  <div class="container mt-4">
    <h1 class="text-center"><i class="fas fa-tractor"></i> EC Hayvancılık Günlük Rapor Sistemi</h1>
    <div id="login-form" class="card p-4 mx-auto" style="max-width: 400px;">
      <h2 class="text-center mb-4">Giriş Yap</h2>
      <div class="mb-3">
        <input type="text" id="username" class="form-control mb-2" placeholder="Kullanıcı Adı">
      </div>
      <div class="mb-3">
        <input type="password" id="password" class="form-control mb-2" placeholder="Şifre">
      </div>
      <button onclick="login()" class="btn btn-primary w-100 py-2"><i class="fas fa-sign-in-alt"></i> Giriş</button>
    </div>
    <div id="dashboard" style="display:none;" class="mt-4">
      <div id="dashboard-content"></div>
      <div id="change-credentials" style="display:none;" class="card p-4 mx-auto" style="max-width: 400px;">
        <h3 class="mb-3">Şifreyi Değiştir</h3>
        <div id="user-select" style="display:none;" class="mb-3">
          <label for="target-user" class="form-label">Kullanıcı Seç:</label>
          <select id="target-user" class="form-control"></select>
        </div>
        <div class="mb-3">
          <input type="password" id="new-password" class="form-control mb-2" placeholder="Yeni Şifre">
        </div>
        <button onclick="changeCredentials()" class="btn btn-warning w-100 py-2"><i class="fas fa-key"></i> Değiştir</button>
      </div>
      <button onclick="logout()" class="btn btn-danger w-100 mt-3 py-2"><i class="fas fa-sign-out-alt"></i> Çıkış Yap</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
    import { getAuth, signInAnonymously, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, query, where, getDocs, collection } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCildgfGrsyzGkOC6ClKHji_HunnJC3r2k",
      authDomain: "ec-farm-report-1d359.firebaseapp.com",
      projectId: "ec-farm-report-1d359",
      storageBucket: "ec-farm-report-1d359.firebasestorage.app",
      messagingSenderId: "751990003577",
      appId: "1:751990003577:web:e9036a63855828134e01a8"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const coops = ['1A', '1B', '2A', '2B', '3A', '3B', '4A', '4B', '5A', '5B', '6A', '6B', '7A', '7B', '8A', '8B', '9A', '9B'];
    const side15 = coops.slice(0,10);
    const side69 = coops.slice(10);
    const timeSlots = ['08:00', '09:00', '10:15', '13:00', '14:15'];

    window.login = async () => {
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      try {
        const userCredential = await signInAnonymously(auth);
        const user = userCredential.user;
        const userDoc = await getDoc(doc(db, 'users', username));
        if (userDoc.exists() && userDoc.data().password === password) {
          localStorage.setItem('currentUser', username);
          await loadDashboard(userDoc.data().role, userDoc.data().coop, userDoc.data().side);
          document.getElementById('login-form').style.display = 'none';
          document.getElementById('dashboard').style.display = 'block';
        } else {
          alert('Geçersiz kullanıcı adı veya şifre!');
          auth.signOut();
        }
      } catch (error) {
        alert('Giriş hatası: ' + error.message);
      }
    };

    window.logout = async () => {
      try {
        await signOut(auth);
        localStorage.removeItem('currentUser');
        document.getElementById('login-form').style.display = 'block';
        document.getElementById('dashboard').style.display = 'none';
        document.getElementById('change-credentials').style.display = 'none';
        alert('Çıkış yapıldı!');
      } catch (error) {
        alert('Çıkış hatası: ' + error.message);
      }
    };

    onAuthStateChanged(auth, async (user) => {
      if (user && localStorage.getItem('currentUser')) {
        document.getElementById('login-form').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';
        const username = localStorage.getItem('currentUser');
        const userDoc = await getDoc(doc(db, 'users', username));
        const role = userDoc.data().role;
        const coop = userDoc.data().coop;
        const side = userDoc.data().side;
        await loadDashboard(role, coop, side);
        setupChangeCredentials(role, username);
      } else {
        document.getElementById('login-form').style.display = 'block';
        document.getElementById('dashboard').style.display = 'none';
        localStorage.removeItem('currentUser');
      }
    });

    async function loadDashboard(role, coop, side) {
      const today = new Date().toISOString().slice(0,10);
      const reportRef = doc(db, 'daily_reports', today);
      let report = (await getDoc(reportRef)).data() || {};
      if (!report.coops) report.coops = {};
      coops.forEach(c => {
        if (!report.coops[c]) report.coops[c] = {
          dead_chicken_left: 0,
          dead_chicken_right: 0,
          dead_rooster_left: 0,
          dead_rooster_right: 0,
          tray_right_front: 0,
          tray_right_back: 0,
          tray_left_front: 0,
          tray_left_back: 0,
          water_consumption: 0, // Manuel girilen tüketim
          temp_min: 99,
          temp_max: -99,
          floor_eggs: [0,0,0,0,0],
          feed_check: false,
          water_check: false,
          timestamp: today
        };
      });

      const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().slice(0,10);
      const reportsQuery = query(collection(db, 'daily_reports'), where('timestamp', '<', sevenDaysAgo));
      const querySnapshot = await getDocs(reportsQuery);
      querySnapshot.forEach(async (docSnap) => {
        await deleteDoc(doc(db, 'daily_reports', docSnap.id));
      });

      let html = '';
      if (role === 'keeper') {
        html = getKeeperForm(coop, report.coops[coop]);
      } else if (role === 'duty') {
        const myCoops = side === '1-5' ? side15 : side69;
        html = myCoops.map(c => getDutyForm(c, report.coops[c])).join('');
      } else if (role === 'admin') {
        html = getAdminTabs(report.coops);
      }
      document.getElementById('dashboard-content').innerHTML = html;

      if (role !== 'admin') {
        setTimeout(() => {
          const buttons = document.querySelectorAll('.save-btn');
          buttons.forEach(btn => {
            btn.onclick = async (e) => {
              try {
                e.preventDefault();
                const c = btn.dataset.coop;
                const slotElement = document.getElementById(`slot-${c}`);
                const slot = timeSlots.indexOf(slotElement ? slotElement.value : '08:00');
                const addDeadCL = parseInt(document.getElementById(`add-dead-cl-${c}`)?.value || 0);
                const addDeadCR = parseInt(document.getElementById(`add-dead-cr-${c}`)?.value || 0);
                const addDeadRL = parseInt(document.getElementById(`add-dead-rl-${c}`)?.value || 0);
                const addDeadRR = parseInt(document.getElementById(`add-dead-rr-${c}`)?.value || 0);
                const currentTemp = parseFloat(document.getElementById(`temp-${c}`)?.value || 0);
                const floor = parseInt(document.getElementById(`floor-${c}`)?.value || 0);
                const waterConsumption = parseInt(document.getElementById(`water-consumption-${c}`)?.value || 0);
                const feedCheckElement = document.getElementById(`feed-check-${c}`);
                const waterCheckElement = document.getElementById(`water-check-${c}`);
                const feedCheck = feedCheckElement ? feedCheckElement.classList.contains('checked') : false;
                const waterCheck = waterCheckElement ? waterCheckElement.classList.contains('checked') : false;

                let data = report.coops[c];
                data.dead_chicken_left += addDeadCL;
                data.dead_chicken_right += addDeadCR;
                data.dead_rooster_left += addDeadRL;
                data.dead_rooster_right += addDeadRR;
                data.floor_eggs[slot] = floor;
                if (currentTemp < data.temp_min && currentTemp > 0) data.temp_min = currentTemp;
                if (currentTemp > data.temp_max) data.temp_max = currentTemp;

                if (role === 'keeper') {
                  data.tray_right_front = parseInt(document.getElementById(`tray-rf-${c}`)?.value || 0);
                  data.tray_right_back = parseInt(document.getElementById(`tray-rb-${c}`)?.value || 0);
                  data.tray_left_front = parseInt(document.getElementById(`tray-lf-${c}`)?.value || 0);
                  data.tray_left_back = parseInt(document.getElementById(`tray-lb-${c}`)?.value || 0);
                }
                data.water_consumption = waterConsumption;
                data.feed_check = feedCheck;
                data.water_check = waterCheck;

                report.coops[c] = data;
                await setDoc(reportRef, report);
                alert('Veriler kaydedildi!');
                await loadDashboard(role, coop, side);
              } catch (error) {
                console.error('Save error:', error);
                alert('Kaydetme hatası: ' + error.message);
              }
            };
          });

          document.querySelectorAll('.check-box').forEach(box => {
            box.onclick = () => {
              box.classList.toggle('checked');
            };
          });
        }, 500);
      }
    }

    function setupChangeCredentials(role, currentUser) {
      const changeCredentialsDiv = document.getElementById('change-credentials');
      if (role === 'admin') {
        changeCredentialsDiv.style.display = 'block';
        document.getElementById('user-select').style.display = 'block';
        loadUserList();
      } else if (role === 'keeper') {
        const hasChanged = localStorage.getItem(`passwordChanged_${currentUser}`) === 'true';
        changeCredentialsDiv.style.display = hasChanged ? 'none' : 'block';
        document.getElementById('user-select').style.display = 'none';
      } else if (role === 'duty') {
        changeCredentialsDiv.style.display = 'block';
        document.getElementById('user-select').style.display = 'none';
      }
    }

    async function loadUserList() {
      const usersRef = collection(db, 'users');
      const querySnapshot = await getDocs(usersRef);
      const select = document.getElementById('target-user');
      select.innerHTML = '';
      querySnapshot.forEach((doc) => {
        const user = doc.id;
        const option = document.createElement('option');
        option.value = user;
        option.text = user;
        select.appendChild(option);
      });
    }

    window.changeCredentials = async () => {
      const currentUser = localStorage.getItem('currentUser');
      const userDoc = await getDoc(doc(db, 'users', currentUser));
      const role = userDoc.data().role;

      let targetUser;
      if (role === 'admin') {
        targetUser = document.getElementById('target-user').value;
      } else {
        targetUser = currentUser;
      }

      const newPassword = document.getElementById('new-password').value;
      if (!newPassword) {
        alert('Yeni şifre giriniz!');
        return;
      }

      try {
        const userRef = doc(db, 'users', targetUser);
        await updateDoc(userRef, { password: newPassword });

        if (role === 'keeper' && !localStorage.getItem(`passwordChanged_${currentUser}`)) {
          localStorage.setItem(`passwordChanged_${currentUser}`, 'true');
        }

        alert('Şifre başarıyla değiştirildi!');
        document.getElementById('new-password').value = '';
        setupChangeCredentials(role, currentUser);
      } catch (error) {
        alert('Hata oluştu: ' + error.message);
      }
    };

    function getKeeperForm(coop, data) {
      return `
        <div class="card p-4 mb-3">
          <h3>${coop} Kümes Verileri - Tarih: ${data.timestamp}</h3>
          <div class="mb-3">
            <label for="slot-${coop}" class="form-label">Giriş Saati:</label>
            <select id="slot-${coop}" class="form-control">
              ${timeSlots.map(t => `<option>${t}</option>`).join('')}
            </select>
          </div>
          <div class="mb-3">
            <label for="add-dead-cl-${coop}" class="form-label">Ek Ölü Tavuk Sol:</label>
            <input type="number" id="add-dead-cl-${coop}" class="form-control" value="0">
          </div>
          <div class="mb-3">
            <label for="add-dead-cr-${coop}" class="form-label">Ek Ölü Tavuk Sağ:</label>
            <input type="number" id="add-dead-cr-${coop}" class="form-control" value="0">
          </div>
          <div class="mb-3">
            <label for="add-dead-rl-${coop}" class="form-label">Ek Ölü Horoz Sol:</label>
            <input type="number" id="add-dead-rl-${coop}" class="form-control" value="0">
          </div>
          <div class="mb-3">
            <label for="add-dead-rr-${coop}" class="form-label">Ek Ölü Horoz Sağ:</label>
            <input type="number" id="add-dead-rr-${coop}" class="form-control" value="0">
          </div>
          <div class="mb-3">
            <label for="temp-${coop}" class="form-label">Geçerli Sıcaklık:</label>
            <input type="number" id="temp-${coop}" class="form-control">
          </div>
          <div class="mb-3">
            <label for="floor-${coop}" class="form-label">Yer Yumurtası Sayısı:</label>
            <input type="number" id="floor-${coop}" class="form-control" value="0">
          </div>
          <div class="mb-3">
            <label for="tray-rf-${coop}" class="form-label">Sağ Ön Dolu Tabak:</label>
            <input type="number" id="tray-rf-${coop}" class="form-control" value="${data.tray_right_front}">
          </div>
          <div class="mb-3">
            <label for="tray-rb-${coop}" class="form-label">Sağ Arka Dolu Tabak:</label>
            <input type="number" id="tray-rb-${coop}" class="form-control" value="${data.tray_right_back}">
          </div>
          <div class="mb-3">
            <label for="tray-lf-${coop}" class="form-label">Sol Ön Dolu Tabak:</label>
            <input type="number" id="tray-lf-${coop}" class="form-control" value="${data.tray_left_front}">
          </div>
          <div class="mb-3">
            <label for="tray-lb-${coop}" class="form-label">Sol Arka Dolu Tabak:</label>
            <input type="number" id="tray-lb-${coop}" class="form-control" value="${data.tray_left_back}">
          </div>
          <div class="mb-3">
            <label for="water-consumption-${coop}" class="form-label">Tüketilen Su Miktarı (Litre):</label>
            <input type="number" id="water-consumption-${coop}" class="form-control" value="${data.water_consumption}">
          </div>
          <div class="check-box ${data.feed_check ? 'checked' : ''}" id="feed-check-${coop}">Dişi yemi kontrolü yapıldı</div>
          <div class="check-box ${data.water_check ? 'checked' : ''}" id="water-check-${coop}">Suluk kontrolü yapıldı</div>
          <button class="btn btn-primary w-100 py-2 save-btn" data-coop="${coop}"><i class="fas fa-save"></i> Kaydet</button>
        </div>
      `;
    }

    function getDutyForm(coop, data) {
      return `
        <div class="card p-4 mb-3">
          <h3>${coop} Kümes Verileri (Nöbetçi) - Tarih: ${data.timestamp}</h3>
          <div class="mb-3">
            <label for="slot-${coop}" class="form-label">Giriş Saati:</label>
            <select id="slot-${coop}" class="form-control">
              ${timeSlots.map(t => `<option>${t}</option>`).join('')}
            </select>
          </div>
          <div class="mb-3">
            <label for="add-dead-cl-${coop}" class="form-label">Ek Ölü Tavuk Sol:</label>
            <input type="number" id="add-dead-cl-${coop}" class="form-control" value="0">
          </div>
          <div class="mb-3">
            <label for="add-dead-cr-${coop}" class="form-label">Ek Ölü Tavuk Sağ:</label>
            <input type="number" id="add-dead-cr-${coop}" class="form-control" value="0">
          </div>
          <div class="mb-3">
            <label for="add-dead-rl-${coop}" class="form-label">Ek Ölü Horoz Sol:</label>
            <input type="number" id="add-dead-rl-${coop}" class="form-control" value="0">
          </div>
          <div class="mb-3">
            <label for="add-dead-rr-${coop}" class="form-label">Ek Ölü Horoz Sağ:</label>
            <input type="number" id="add-dead-rr-${coop}" class="form-control" value="0">
          </div>
          <div class="mb-3">
            <label for="temp-${coop}" class="form-label">Geçerli Sıcaklık:</label>
            <input type="number" id="temp-${coop}" class="form-control">
          </div>
          <div class="mb-3">
            <label for="floor-${coop}" class="form-label">Yer Yumurtası Sayısı:</label>
            <input type="number" id="floor-${coop}" class="form-control" value="0">
          </div>
          <div class="mb-3">
            <label for="water-consumption-${coop}" class="form-label">Tüketilen Su Miktarı (Litre):</label>
            <input type="number" id="water-consumption-${coop}" class="form-control" value="${data.water_consumption}">
          </div>
          <div class="check-box ${data.feed_check ? 'checked' : ''}" id="feed-check-${coop}">Dişi yemi kontrolü yapıldı</div>
          <div class="check-box ${data.water_check ? 'checked' : ''}" id="water-check-${coop}">Suluk kontrolü yapıldı</div>
          <button class="btn btn-primary w-100 py-2 save-btn" data-coop="${coop}"><i class="fas fa-save"></i> Kaydet</button>
        </div>
      `;
    }

    function getAdminTabs(coopsData) {
      let tabs = '<ul class="nav nav-tabs" id="coopTabs">';
      coops.forEach(c => tabs += `<li class="nav-item"><a class="nav-link ${c === '1A' ? 'active' : ''}" href="#" onclick="switchCoopTab('${c}')">${c}</a></li>`);
      tabs += '</ul><div class="tab-content mt-3">';
      coops.forEach(c => {
        tabs += `
          <div id="tab-${c}" class="tab-pane ${c === '1A' ? 'active' : ''}">
            <div class="card p-4 mb-3">
              <h3>${c} Kümes Verileri - Tarih: ${coopsData[c].timestamp}</h3>
              <table class="table table-striped table-bordered">
                <tbody>
                  ${getTableRow('Ölü Tavuk Sol', coopsData, 'dead_chicken_left', c)}
                  ${getTableRow('Ölü Tavuk Sağ', coopsData, 'dead_chicken_right', c)}
                  ${getTableRow('Ölü Horoz Sol', coopsData, 'dead_rooster_left', c)}
                  ${getTableRow('Ölü Horoz Sağ', coopsData, 'dead_rooster_right', c)}
                  ${getTableRow('Sağ Ön Dolu Tabak', coopsData, 'tray_right_front', c)}
                  ${getTableRow('Sağ Arka Dolu Tabak', coopsData, 'tray_right_back', c)}
                  ${getTableRow('Sol Ön Dolu Tabak', coopsData, 'tray_left_front', c)}
                  ${getTableRow('Sol Arka Dolu Tabak', coopsData, 'tray_left_back', c)}
                  ${getTableRow('Su Tüketimi (Litre)', coopsData, 'water_consumption', c)}
                  ${getTableRow('Min Sıcaklık', coopsData, 'temp_min', c)}
                  ${getTableRow('Max Sıcaklık', coopsData, 'temp_max', c)}
                  ${getTableRow('Toplam Yer Yumurtası', coopsData, 'floor_eggs', c, true)}
                  ${getTableRow('Dişi Yemi Kontrol', coopsData, 'feed_check', c)}
                  ${getTableRow('Suluk Kontrol', coopsData, 'water_check', c)}
                  ${getTotalRow(c, coopsData[c])}
                </tbody>
              </table>
              <button onclick="window.print()" class="btn btn-success w-100 mt-3 py-2"><i class="fas fa-print"></i> Yazdır</button>
            </div>
          </div>
        `;
      });
      tabs += '</div>';
      return tabs;
    }

    function getTableRow(label, data, key, coop, sum=false) {
      let val = data[coop][key];
      if (sum) val = val.reduce((a,b)=>a+b,0);
      return `<tr><td>${label}</td><td>${val !== undefined ? val : 'N/A'}</td></tr>`;
    }

    function getTotalRow(coop, data) {
      const totalChickens = data.dead_chicken_left + data.dead_chicken_right;
      const totalRoosters = data.dead_rooster_left + data.dead_rooster_right;
      const totalEggs = data.floor_eggs.reduce((a,b)=>a+b,0) +
                       data.tray_right_front + data.tray_right_back +
                       data.tray_left_front + data.tray_left_back;
      return `
        <tr><td>Toplam Ölü Tavuk</td><td>${totalChickens}</td></tr>
        <tr><td>Toplam Ölü Horoz</td><td>${totalRoosters}</td></tr>
        <tr><td>Toplam Yumurta Sayısı</td><td>${totalEggs}</td></tr>
      `;
    }

    function switchCoopTab(coop) {
      document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
      document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
      document.querySelector(`.nav-link:contains('${coop}')`).classList.add('active');
      document.getElementById(`tab-${coop}`).classList.add('active');
    }
  </script>
</body>
</html>
